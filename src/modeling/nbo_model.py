"""
–ú–æ–¥—É–ª—å –¥–ª—è –º–æ–¥–µ–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π Next Best Offer.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
"""

import joblib
from pathlib import Path
from typing import Dict, List, Optional
from collections import defaultdict
import numpy as np
from sklearn.ensemble import RandomForestRegressor
from sklearn.preprocessing import StandardScaler

from src.features.user_profile import profile_to_features
from src.utils.category_normalizer import CATEGORY_KEYWORDS as NORMALIZED_CATEGORY_KEYWORDS, check_category_match
from src.utils.yandex_gpt_client import call_yandex_gpt


class NBOModel:
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ Next Best Offer.
    """
    
    def __init__(self, model_path: Optional[str] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏.
        
        :param model_path: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        """
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        if model_path is None:
            # –ü—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            # –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ WORKDIR = /app, –ø–æ—ç—Ç–æ–º—É models/nbo_model.pkl -> /app/models/nbo_model.pkl
            default_path = Path.cwd() / "models" / "nbo_model.pkl"
            self.model_path = str(default_path)
        else:
            self.model_path = model_path
        self.model: Optional[RandomForestRegressor] = None
        self.scaler: Optional[StandardScaler] = None
        self.products: List[str] = []
        
        if Path(self.model_path).exists():
            self.load_model()
        else:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å
            self.model = RandomForestRegressor(
                n_estimators=100,
                max_depth=10,
                random_state=42
            )
            self.scaler = StandardScaler()
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ü–°–ë (50+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
            self.products = [
                "–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–í—Ç–æ—Ä–∏—á–Ω–æ–µ –∂–∏–ª—å–µ¬ª",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞¬ª",
                "–ì–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–°–µ–º–µ–π–Ω–∞—è –≤–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è –∏ –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ö—Ä–µ–¥–∏—Ç –ø–æ–¥ –∑–∞–ª–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä—ã",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ (–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)",
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª",
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥¬ª",
                "–ö–ª—É–±–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–§–ö –¶–°–ö–ê",
                "–ö–∞—Ä—Ç–∞ ¬´–°–í–û–∏¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –ø–µ–Ω—Å–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–°–ë",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –ü–ª—é—Å¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–°–∏–ª—å–Ω—ã–µ –ª—é–¥–∏¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–ó–∞—Ä–ø–ª–∞—Ç–∞ PRO¬ª",
                "–ö–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è",
                "–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏",
                "–ö—Ä–µ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –û–ü–ö –∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏—Ö",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–≠–∫—Å–ø—Ä–µ—Å—Å-–∫—Ä–µ–¥–∏—Ç ¬´–¢—É—Ä–±–æ–¥–µ–Ω—å–≥–∏¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª",
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ¬ª",
                "–í–∫–ª–∞–¥ ¬´–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ—è –∫–æ–ø–∏–ª–∫–∞¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª",
                "–í–∫–ª–∞–¥ ¬´–í —é–∞–Ω—è—Ö¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–•—Ä–∞–Ω–∏—Ç–µ–ª—å¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ê–∫—Ü–µ–Ω—Ç¬ª",
                "–ü–°–ë –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏",
                "–ü–∞–∫–µ—Ç ¬´Orange Premium Club¬ª",
                "–ú—É–ª—å—Ç–∏–Æ—Ä–∏—Å—Ç",
                "–ó–∞—â–∏—Ç–∞ –≤–∫–ª–∞–¥–∞",
                "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞",
                "–î–æ–º–∞—à–Ω–∏–π –∫—ç—à–±—ç–∫",
                "–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π",
                "–ê–≤—Ç–æ–ø–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö",
                "–ë—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã",
                "–ú–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤",
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
                "–û–°–ê–ì–û",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Ä–∞–±–æ—Ç—ã",
                "–ü—Ä–∏–µ–º–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∂–∏–ª—å—è",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∂–∏–∑–Ω–∏",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∑–∞–µ–º—â–∏–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ—á–Ω—ã—Ö –∑–∞–µ–º—â–∏–∫–æ–≤"
            ]
    
    def load_model(self) -> None:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å –∏–∑ —Ñ–∞–π–ª–∞."""
        try:
            data = joblib.load(self.model_path)
            self.model = data["model"]
            self.scaler = data.get("scaler")
            self.products = data.get("products", [
                "–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–í—Ç–æ—Ä–∏—á–Ω–æ–µ –∂–∏–ª—å–µ¬ª",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞¬ª",
                "–ì–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–°–µ–º–µ–π–Ω–∞—è –≤–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è –∏ –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ö—Ä–µ–¥–∏—Ç –ø–æ–¥ –∑–∞–ª–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä—ã",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ (–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)",
                "–ú—É–ª—å—Ç–∏–Æ—Ä–∏—Å—Ç",
                "–ó–∞—â–∏—Ç–∞ –≤–∫–ª–∞–¥–∞",
                "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞",
                "–î–æ–º–∞—à–Ω–∏–π –∫—ç—à–±—ç–∫",
                "–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π",
                "–ê–≤—Ç–æ–ø–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö",
                "–ë—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã",
                "–ú–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤",
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
                "–û–°–ê–ì–û",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Ä–∞–±–æ—Ç—ã",
                "–ü—Ä–∏–µ–º–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∂–∏–ª—å—è",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∂–∏–∑–Ω–∏",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∑–∞–µ–º—â–∏–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ—á–Ω—ã—Ö –∑–∞–µ–º—â–∏–∫–æ–≤",
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª", 
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª", 
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ¬ª",
                "–í–∫–ª–∞–¥ ¬´–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ—è –∫–æ–ø–∏–ª–∫–∞¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª",
                "–í–∫–ª–∞–¥ ¬´–í —é–∞–Ω—è—Ö¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥¬ª",
                "–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–≠–∫—Å–ø—Ä–µ—Å—Å-–∫—Ä–µ–¥–∏—Ç ¬´–¢—É—Ä–±–æ–¥–µ–Ω—å–≥–∏¬ª",
                "–ö—Ä–µ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –û–ü–ö –∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏—Ö",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ê–∫—Ü–µ–Ω—Ç¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–•—Ä–∞–Ω–∏—Ç–µ–ª—å¬ª",
                "–ü–°–ë –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏",
                "–ü–∞–∫–µ—Ç ¬´Orange Premium Club¬ª",
                "–ö–ª—É–±–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–§–ö –¶–°–ö–ê",
                "–ö–∞—Ä—Ç–∞ ¬´–°–í–û–∏¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –ø–µ–Ω—Å–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–°–ë",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –ü–ª—é—Å¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–°–∏–ª—å–Ω—ã–µ –ª—é–¥–∏¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–ó–∞—Ä–ø–ª–∞—Ç–∞ PRO¬ª",
                "–ö–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è"
            ])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
            self.model = RandomForestRegressor(n_estimators=100, max_depth=10, random_state=42)
            self.scaler = StandardScaler()
            self.products = [
                "–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–í—Ç–æ—Ä–∏—á–Ω–æ–µ –∂–∏–ª—å–µ¬ª",
                "–ò–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞¬ª",
                "–ì–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–°–µ–º–µ–π–Ω–∞—è –≤–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
                "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è –∏ –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–ø–æ—Ç–µ–∫–∞",
                "–ö—Ä–µ–¥–∏—Ç –ø–æ–¥ –∑–∞–ª–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä—ã",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏",
                "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ (–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)",
                "–ú—É–ª—å—Ç–∏–Æ—Ä–∏—Å—Ç",
                "–ó–∞—â–∏—Ç–∞ –≤–∫–ª–∞–¥–∞",
                "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞",
                "–î–æ–º–∞—à–Ω–∏–π –∫—ç—à–±—ç–∫",
                "–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π",
                "–ê–≤—Ç–æ–ø–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö",
                "–ë—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã",
                "–ú–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤",
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
                "–û–°–ê–ì–û",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Ä–∞–±–æ—Ç—ã",
                "–ü—Ä–∏–µ–º–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∂–∏–ª—å—è",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∂–∏–∑–Ω–∏",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∑–∞–µ–º—â–∏–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ—á–Ω—ã—Ö –∑–∞–µ–º—â–∏–∫–æ–≤",
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª", 
                "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª", 
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ¬ª",
                "–í–∫–ª–∞–¥ ¬´–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ—è –∫–æ–ø–∏–ª–∫–∞¬ª",
                "–í–∫–ª–∞–¥ ¬´–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª",
                "–í–∫–ª–∞–¥ ¬´–í —é–∞–Ω—è—Ö¬ª",
                "–í–∫–ª–∞–¥ ¬´–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥¬ª",
                "–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏",
                "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤",
                "–≠–∫—Å–ø—Ä–µ—Å—Å-–∫—Ä–µ–¥–∏—Ç ¬´–¢—É—Ä–±–æ–¥–µ–Ω—å–≥–∏¬ª",
                "–ö—Ä–µ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –û–ü–ö –∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏—Ö",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ê–∫—Ü–µ–Ω—Ç¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª",
                "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–•—Ä–∞–Ω–∏—Ç–µ–ª—å¬ª",
                "–ü–°–ë –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏",
                "–ü–∞–∫–µ—Ç ¬´Orange Premium Club¬ª",
                "–ö–ª—É–±–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–§–ö –¶–°–ö–ê",
                "–ö–∞—Ä—Ç–∞ ¬´–°–í–û–∏¬ª",
                "–î–µ–±–µ—Ç–æ–≤–∞—è –ø–µ–Ω—Å–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–°–ë",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –ü–ª—é—Å¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–°–∏–ª—å–Ω—ã–µ –ª—é–¥–∏¬ª",
                "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–ó–∞—Ä–ø–ª–∞—Ç–∞ PRO¬ª",
                "–ö–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è"
            ]
    
    def save_model(self) -> None:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å –≤ —Ñ–∞–π–ª."""
        try:
            # –°–æ–∑–¥–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            model_path = Path(self.model_path)
            if not model_path.is_absolute():
                # –ï—Å–ª–∏ –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π, –¥–µ–ª–∞–µ–º –µ–≥–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –æ—Ç —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                model_path = Path.cwd() / model_path
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            model_path.parent.mkdir(parents=True, exist_ok=True)
            
            data = {
                "model": self.model,
                "scaler": self.scaler,
                "products": self.products
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å
            joblib.dump(data, str(model_path))
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –º–æ–¥–µ–ª–∏ –Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
            self.model_path = str(model_path)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω
            if model_path.exists():
                file_size = model_path.stat().st_size
                print(f"‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {self.model_path} (—Ä–∞–∑–º–µ—Ä: {file_size / 1024:.2f} KB)")
            else:
                print(f"‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {self.model_path}")
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏ –≤ {self.model_path}: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    def train(
        self,
        X: List[List[float]],
        y: List[str],
        products: Optional[List[str]] = None
    ) -> None:
        """
        –û–±—É—á–∞–µ—Ç –º–æ–¥–µ–ª—å.
        
        :param X: –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        :param y: –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        :param products: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        """
        if products:
            self.products = products
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–µ—Ç–∫–∏ –≤ —á–∏—Å–ª–æ–≤—ã–µ
        product_to_idx = {p: i for i, p in enumerate(self.products)}
        y_numeric = [product_to_idx.get(label, 0) for label in y]
        
        # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
        X_scaled = self.scaler.fit_transform(X)
        
        # –û–±—É—á–∞–µ–º –º–æ–¥–µ–ª—å
        print(f"üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –Ω–∞ {len(X)} –ø—Ä–∏–º–µ—Ä–∞—Ö...")
        self.model.fit(X_scaled, y_numeric)
        print("‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å
        print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤: {self.model_path}")
        self.save_model()
    
    def train_with_yandexgpt(
        self,
        user_profiles: List[Dict],
        use_synthetic: bool = True
    ) -> None:
        """
        –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å –ø–æ–º–æ—â—å—é YandexGPT.
        
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
        –∏—Å–ø–æ–ª—å–∑—É—è YandexGPT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
        
        :param user_profiles: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        :param use_synthetic: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç YandexGPT
        """
        print("ü§ñ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å YandexGPT...")
        print(f"üìÅ –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {Path(self.model_path).resolve()}")
        
        X_train = []
        y_train = []
        
        # –û–±—É—á–∞–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è—Ö
        import time
        total_profiles = len(user_profiles)
        print(f"üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ {total_profiles} –ø—Ä–æ—Ñ–∏–ª–µ–π...")
        
        for i, profile in enumerate(user_profiles[:50], 1):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
            try:
                features = profile_to_features(profile)
                X_train.append(features)
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexGPT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
                print(f"  [{i}/{min(50, total_profiles)}] –ó–∞–ø—Ä–æ—Å –∫ YandexGPT –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è...")
                product = self._get_recommendation_from_yandexgpt(profile)
                y_train.append(product)
                
                # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limiting
                if i < min(50, total_profiles):
                    time.sleep(0.5)
            except Exception as e:
                print(f"‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: {e}")
                continue
        
        # –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if use_synthetic and len(user_profiles) > 0:
            print("üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ YandexGPT...")
            synthetic_data = self._generate_synthetic_training_data(user_profiles[:10])
            X_train.extend(synthetic_data["X"])
            y_train.extend(synthetic_data["y"])
        
        if len(X_train) > 0:
            print(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(X_train)} –æ–±—É—á–∞—é—â–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤")
            self.train(X_train, y_train)
            print("‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±—É—á–µ–Ω–∞ —Å –ø–æ–º–æ—â—å—é YandexGPT")
        else:
            print("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ")
    
    def _get_recommendation_from_yandexgpt(self, profile: Dict) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –æ—Ç YandexGPT –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è.
        
        :param profile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :return: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        """
        # –°–∂–∞—Ç—ã–π –ø—Ä–æ–º–ø—Ç (—Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏)
        avg_tx = profile.get('avg_tx', 0)
        num_payments = profile.get('num_payments', 0)
        top_category = profile.get('top_category') or profile.get('top_brand_category', '')
        
        parts = [f"–ü–ª:{num_payments}", f"–ß–µ–∫:${avg_tx:.0f}"]
        if top_category:
            cat_short = top_category[:15] if len(top_category) > 15 else top_category
            parts.append(f"–ö:{cat_short}")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ü–°–ë –≤ –ø—Ä–æ–º–ø—Ç–µ (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ (—Ç–æ–ø-10 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö)
        product_examples_short = "–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞/–ò–ø–æ—Ç–µ–∫–∞ ¬´–í—Ç–æ—Ä–∏—á–Ω–æ–µ –∂–∏–ª—å–µ¬ª/–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª/–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª/–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª/–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏/–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª/–ü–°–ë –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏/–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª/–û–°–ê–ì–û"
        
        # –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        all_products_list = ", ".join(self.products[:30])  # –ü–µ—Ä–≤—ã–µ 30 –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
        
        prompt = "|".join(parts) + f"|–ü—Ä–æ–¥—É–∫—Ç –ü–°–ë? ({product_examples_short})"
        
        try:
            response = call_yandex_gpt(
                input_text=prompt,
                instructions=(
                    f"–≠–∫—Å–ø–µ—Ä—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ü–°–ë. –ü—Ä–æ—Ñ–∏–ª—å ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –ü–°–ë. "
                    f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: {all_products_list}. "
                    f"–û—Ç–≤–µ—Ç: –¢–û–õ–¨–ö–û —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞. "
                    f"–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–∏–ø–∞ '–ö—Ä–µ–¥–∏—Ç', '–ò–ø–æ—Ç–µ–∫–∞', '–ö—Ä–µ–¥–∏—Ç–∫–∞'. "
                    f"–ü—Ä–∏–º–µ—Ä—ã: '–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏', '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª', '–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª'."
                ),
                temperature=0.3
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            response = response.strip()
            for product in self.products:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ —Ç–æ—á–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ, —Ç–∞–∫ –∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ
                if product.lower() in response.lower() or response.lower() in product.lower():
                    return product
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback
            # –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            response_lower = response.lower()
            if any(kw in response_lower for kw in ["–∏–ø–æ—Ç–µ", "mortgage"]):
                return "–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"
            elif any(kw in response_lower for kw in ["–∫—Ä–µ–¥–∏—Ç–Ω", "credit card"]):
                return "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"
            elif any(kw in response_lower for kw in ["–≤–∫–ª–∞–¥", "deposit"]):
                return "–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"
            elif any(kw in response_lower for kw in ["–∫—Ä–µ–¥–∏—Ç", "loan"]):
                return "–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"
            else:
                return "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª"
        except Exception as e:
            print(f"‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç YandexGPT: {e}")
            # –£–ª—É—á—à–µ–Ω–Ω—ã–π fallback –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ü–°–ë
            total_tx = profile.get('total_tx', 0)
            num_payments = profile.get('num_payments', 0)
            if total_tx > 100000:
                return "–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"
            elif num_payments > 5:
                return "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"
            else:
                return "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª"
    
    def _generate_synthetic_training_data(self, sample_profiles: List[Dict]) -> Dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ YandexGPT.
        
        :param sample_profiles: –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
        :return: –°–ª–æ–≤–∞—Ä—å —Å X –∏ y –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        """
        X_synthetic = []
        y_synthetic = []
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
        for profile in sample_profiles[:5]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
            try:
                # –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
                variations = [
                    {**profile, "num_payments": int(profile.get("num_payments", 0) * 1.5)},
                    {**profile, "total_tx": profile.get("total_tx", 0) * 2},
                    {**profile, "num_views": int(profile.get("num_views", 0) * 1.2)},
                ]
                
                for var_profile in variations:
                    features = profile_to_features(var_profile)
                    X_synthetic.append(features)
                    
                    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –æ—Ç YandexGPT
                    product = self._get_recommendation_from_yandexgpt(var_profile)
                    y_synthetic.append(product)
            except Exception as e:
                print(f"‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: {e}")
                continue
        
        return {"X": X_synthetic, "y": y_synthetic}
    
    def predict(
        self,
        user_profile: Dict,
        top_k: int = 3,
        graph: Optional[any] = None,
        patterns: Optional[List] = None
    ) -> List[Dict[str, any]]:
        """
        –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-K –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        :param user_profile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        :param graph: –ì—Ä–∞—Ñ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ fallback)
        :param patterns: –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ fallback)
        :return: –°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—É—á–µ–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å
        if self.model is None:
            return self._fallback_recommendations(user_profile, top_k, graph, patterns)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—É—á–µ–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å (–µ—Å—Ç—å –ª–∏ –∞—Ç—Ä–∏–±—É—Ç n_estimators_ –ø–æ—Å–ª–µ fit)
        if not hasattr(self.model, 'estimators_') or len(self.model.estimators_) == 0:
            print("‚ö† –ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback —Å –∞–Ω–∞–ª–∏–∑–æ–º –≥—Ä–∞—Ñ–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤")
            return self._fallback_recommendations(user_profile, top_k, graph, patterns)
        
        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –ø—Ä–∏–∑–Ω–∞–∫–∏
            features = profile_to_features(user_profile)
            X = np.array([features])
            
            # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ scaler –æ–±—É—á–µ–Ω
            if self.scaler and hasattr(self.scaler, 'mean_') and self.scaler.mean_ is not None:
                # Scaler –æ–±—É—á–µ–Ω (mean_ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ fit)
                try:
                    X_scaled = self.scaler.transform(X)
                except Exception as e:
                    # –ï—Å–ª–∏ transform –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
                    print(f"‚ö† –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å scaler: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è")
                    X_scaled = X
            else:
                # Scaler –Ω–µ –æ–±—É—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
                X_scaled = X
            
            # –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
            scores = []
            for i, product in enumerate(self.products):
                # –°–æ–∑–¥–∞–µ–º –±–∏–Ω–∞—Ä–Ω—É—é –º–µ—Ç–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
                y_binary = np.zeros(len(self.products))
                y_binary[i] = 1
                
                # –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
                score = self.model.predict(X_scaled)[0]
                scores.append((product, float(score)))
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∫–µ
            scores.sort(key=lambda x: x[1], reverse=True)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-K
            recommendations = [
                {
                    "product": product,
                    "score": score
                }
                for product, score in scores[:top_k]
            ]
            
            return recommendations
        except Exception as e:
            print(f"‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏ –º–æ–¥–µ–ª–∏: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback")
            return self._fallback_recommendations(user_profile, top_k, graph, patterns)
    
    def _fallback_recommendations(
        self,
        user_profile: Dict,
        top_k: int = 3,
        graph: Optional[any] = None,
        patterns: Optional[List] = None
    ) -> List[Dict[str, any]]:
        """
        –£–ª—É—á—à–µ–Ω–Ω—ã–π fallback –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è, –≥—Ä–∞—Ñ–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
        
        :param user_profile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        :param graph: –ì—Ä–∞—Ñ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        :param patterns: –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        :return: –°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        """
        recommendations = []
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤)
        CATEGORY_KEYWORDS = NORMALIZED_CATEGORY_KEYWORDS
        
        # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é)
        def check_category(category_str, keywords_list):
            """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞."""
            if not category_str:
                return False
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
            cat_lower = str(category_str).lower()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–æ–Ω–∏ —É–∂–µ –≤–∫–ª—é—á–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —è–∑—ã–∫–∏)
            return any(kw in cat_lower for kw in keywords_list)
        
        # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ —Å–ø–∏—Å–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        def count_category_matches(categories, keywords_list):
            """–ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞."""
            if not categories:
                return 0
            return sum(1 for cat in categories if check_category(cat, keywords_list))
        
        # –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        num_payments = user_profile.get("num_payments", 0)
        total_tx = user_profile.get("total_tx", 0)
        avg_tx = user_profile.get("avg_tx", 0)
        num_views = user_profile.get("num_views", 0)
        days_active = user_profile.get("days_active", 0)
        unique_items = user_profile.get("unique_items", 0)
        top_category = user_profile.get("top_category")
        top_brand = user_profile.get("top_brand")
        top_brand_category = user_profile.get("top_brand_category")
        brand_categories = user_profile.get("brand_categories", [])
        
        # –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ retail –∏ receipts
        num_retail_events = user_profile.get("num_retail_events", 0)
        num_retail_orders = user_profile.get("num_retail_orders", 0)
        action_types = user_profile.get("action_types", {})
        
        # –ê–Ω–∞–ª–∏–∑ action_type –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è
        num_add_to_cart = action_types.get("add_to_cart", 0)
        num_orders = action_types.get("order", 0) + num_retail_orders
        num_clicks = action_types.get("click", 0)
        
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ embedding –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        embedding_diversity = user_profile.get("embedding_diversity", 0.0)
        # –í—ã—Å–æ–∫–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ embedding = —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã = –º–æ–∂–µ—Ç –Ω—É–∂–µ–Ω –∫—Ä–µ–¥–∏—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
        # –í–ê–ñ–ù–û: loan_score –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ–∑–∂–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        embedding_loan_boost = 0.15 * min(embedding_diversity, 1.0) if embedding_diversity > 0.1 else 0.0
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ü–ï–†–ï–î –∞–Ω–∞–ª–∏–∑–æ–º (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è - –≤—ã—á–∏—Å–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤
        
        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        NORM_TOTAL_TX = 200000.0
        NORM_AVG_TX = 50000.0
        NORM_PAYMENTS = 20.0
        NORM_VIEWS = 50.0
        NORM_ITEMS = 30.0
        NORM_DAYS = 14.0
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (0-1 —à–∫–∞–ª–∞)
        max_tx_normalized = min(total_tx / NORM_TOTAL_TX, 1.0) if total_tx > 0 else 0.0
        avg_tx_normalized = min(avg_tx / NORM_AVG_TX, 1.0) if avg_tx > 0 else 0.0
        payment_frequency = min(num_payments / NORM_PAYMENTS, 1.0) if num_payments > 0 else 0.0
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        activity_intensity = min(num_views / NORM_VIEWS, 1.0) if num_views > 0 else 0.0
        diversity_score = min(unique_items / NORM_ITEMS, 1.0) if unique_items > 0 else 0.0
        engagement_duration = min(days_active / NORM_DAYS, 1.0) if days_active > 0 else 0.0
        
        # –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤)
        high_value_customer = (max_tx_normalized * 0.5 + avg_tx_normalized * 0.3 + payment_frequency * 0.2)
        research_behavior = (activity_intensity * 0.4 + diversity_score * 0.4 + engagement_duration * 0.2)
        active_spender = (payment_frequency * 0.5 + avg_tx_normalized * 0.3 + engagement_duration * 0.2)
        
        # –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω) - –∏—Å–ø–æ–ª—å–∑—É–µ–º defaultdict –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        graph_scores = defaultdict(float)
        if graph is not None:
            try:
                import networkx as nx
                
                if graph.number_of_nodes() > 0:
                    # 1. PageRank –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ—Å—Ç–∏ —É–∑–ª–æ–≤
                    try:
                        pagerank = nx.pagerank(graph, max_iter=100, weight='weight')
                        
                        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø—ã –≤–∞–∂–Ω—ã—Ö —É–∑–ª–æ–≤ –∏ –∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–±—Ä–µ–Ω–¥—ã
                        item_nodes = []
                        brand_nodes = []
                        category_weights = {}
                        brand_weights = {}
                        
                        for node, data in graph.nodes(data=True):
                            node_importance = pagerank.get(node, 0)
                            if node_importance > 0.01:  # –¢–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —É–∑–ª—ã
                                node_type = data.get("type", "unknown")
                                
                                if node_type == "item":
                                    item_nodes.append((node, node_importance))
                                    category_id = data.get("category_id")
                                    if category_id:
                                        category_weights[category_id] = category_weights.get(category_id, 0) + node_importance
                                
                                elif node_type == "brand":
                                    brand_nodes.append((node, node_importance))
                                    brand_id = data.get("brand_id")
                                    if brand_id:
                                        brand_weights[brand_id] = brand_weights.get(brand_id, 0) + node_importance
                        
                        # –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º —É–∑–ª–æ–≤
                        total_item_importance = sum(imp for _, imp in item_nodes)
                        total_brand_importance = sum(imp for _, imp in brand_nodes)
                        
                        # –ï—Å–ª–∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç –±—Ä–µ–Ω–¥—ã - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
                        if total_brand_importance > total_item_importance * 1.5:
                            graph_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] = 0.4
                            graph_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] = 0.25
                            if len(brand_nodes) > 5:
                                graph_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] = 0.35  # –ú–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ = –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
                        
                        # –ï—Å–ª–∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç —Ç–æ–≤–∞—Ä—ã - –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä/–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                        elif total_item_importance > total_brand_importance * 2:
                            graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = 0.3
                            graph_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] = 0.25  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            if len(item_nodes) > 10:
                                graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = 0.4  # –ú–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ = –∫—Ä—É–ø–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
                        
                        # –ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç
                        if category_weights:
                            top_categories = sorted(category_weights.items(), key=lambda x: x[1], reverse=True)[:3]
                            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏/—Ä–µ–º–æ–Ω—Ç–∞ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∏–ø–æ—Ç–µ–∫—É
                            real_estate_keywords = CATEGORY_KEYWORDS["real_estate"][:4]
                            for cat_id, weight in top_categories:
                                cat_str = str(cat_id).lower()
                                if any(keyword in cat_str for keyword in real_estate_keywords):
                                    graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.2 * weight
                                    break
                    except Exception as e:
                        print(f"‚ö† –û—à–∏–±–∫–∞ PageRank –∞–Ω–∞–ª–∏–∑–∞: {e}")
                    
                    # 2. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≥—Ä–∞—Ñ–∞ (–ø—É—Ç–∏ –∏ —Å–≤—è–∑–Ω–æ—Å—Ç—å)
                    try:
                        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø—É—Ç–∏ –æ—Ç START
                        if "START" in graph:
                            reachable = list(nx.descendants(graph, "START"))
                            if reachable:
                                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª–∏–Ω—É –ø—É—Ç–µ–π
                                path_lengths = []
                                for target in reachable[:20]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                                    try:
                                        paths = list(nx.all_simple_paths(graph, "START", target, cutoff=6))
                                        if paths:
                                            path_lengths.extend([len(p) for p in paths[:3]])
                                    except:
                                        continue
                                
                                if path_lengths:
                                    avg_path_length = sum(path_lengths) / len(path_lengths)
                                    max_path_length = max(path_lengths)
                                    
                                    # –î–ª–∏–Ω–Ω—ã–µ –ø—É—Ç–∏ = —Å–ª–æ–∂–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ = –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
                                    if avg_path_length > 4 or max_path_length > 5:
                                        graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.25
                                        graph_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] += 0.2  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                                    
                                    # –ú–Ω–æ–≥–æ –ø—É—Ç–µ–π = –∞–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                                    if len(path_lengths) > 15:
                                        graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.15
                    except Exception as e:
                        print(f"‚ö† –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—É—Ç–µ–π: {e}")
                    
                    # 3. –ê–Ω–∞–ª–∏–∑ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
                    try:
                        density = nx.density(graph) if graph.number_of_nodes() > 1 else 0
                        
                        # –í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å = –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                        if density > 0.3:
                            graph_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] += 0.25
                            graph_scores["–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª"] += 0.2
                        
                        # –ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, –Ω–æ –º–Ω–æ–≥–æ —É–∑–ª–æ–≤ = –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
                        elif density < 0.2 and graph.number_of_nodes() > 10:
                            graph_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.2
                            graph_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] += 0.15  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        
                        # –ê–Ω–∞–ª–∏–∑ —Å—Ç–µ–ø–µ–Ω–∏ —É–∑–ª–æ–≤ (—Å—Ä–µ–¥–Ω—è—è —Å—Ç–µ–ø–µ–Ω—å)
                        degrees = dict(graph.degree())
                        if degrees:
                            avg_degree = sum(degrees.values()) / len(degrees)
                            # –í—ã—Å–æ–∫–∞—è —Å—Ä–µ–¥–Ω—è—è —Å—Ç–µ–ø–µ–Ω—å = –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                            if avg_degree > 3:
                                graph_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] += 0.2
                    except Exception as e:
                        print(f"‚ö† –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏: {e}")
                    
                    # 4. –ê–Ω–∞–ª–∏–∑ –≤–µ—Å–æ–≤ —Ä—ë–±–µ—Ä (—á–∞—Å—Ç–æ—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π)
                    try:
                        edge_weights = [data.get("weight", 1) for _, _, data in graph.edges(data=True)]
                        if edge_weights:
                            avg_weight = sum(edge_weights) / len(edge_weights)
                            max_weight = max(edge_weights)
                            
                            # –í—ã—Å–æ–∫–∏–µ –≤–µ—Å–∞ = —á–∞—Å—Ç—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –¥–µ–π—Å—Ç–≤–∏—è
                            if avg_weight > 2 or max_weight > 5:
                                graph_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] += 0.15
                                graph_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] += 0.1
                    except Exception as e:
                        print(f"‚ö† –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–µ—Å–æ–≤: {e}")
                        
            except Exception as e:
                print(f"‚ö† –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä–∞—Ñ–∞ –≤ fallback: {e}")
        
        # –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã) - –∏—Å–ø–æ–ª—å–∑—É–µ–º defaultdict –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        pattern_scores = defaultdict(float)
        if patterns:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞–º–∏ –∏–ª–∏ –∫–æ—Ä—Ç–µ–∂–∞–º–∏)
            pattern_strings = []
            for p in patterns[:10]:  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ–ª—å—à–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                if isinstance(p, tuple):
                    pattern_strings.append("‚Üí".join([str(x) for x in p]))
                elif isinstance(p, str):
                    pattern_strings.append(p)
            
            combined_pattern = " | ".join(pattern_strings)
            
            # 1. –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö
            view_count = combined_pattern.count("V") + combined_pattern.count("view")
            pay_count = combined_pattern.count("P") + combined_pattern.count("pay")
            click_count = combined_pattern.count("C") + combined_pattern.count("click")
            total_events = view_count + pay_count + click_count
            
            if total_events > 0:
                view_ratio = view_count / total_events
                pay_ratio = pay_count / total_events
                
                # –î–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
                if pay_ratio > 0.5:
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] = 0.4
                    pattern_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] = 0.3
                    if pay_count > 5:
                        pattern_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] = 0.4  # –ú–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π = –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
                
                # –î–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                elif view_ratio > 0.6:
                    pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = 0.35
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] = 0.25  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    if view_count > 10:
                        pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = 0.45  # –ú–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ = –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
                
                # –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                elif 0.3 < view_ratio < 0.6 and 0.2 < pay_ratio < 0.5:
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] = 0.3
                    pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = 0.25
            
            # 2. –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π (—Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
            for pattern_str in pattern_strings:
                # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: V‚ÜíV‚ÜíV –∏–ª–∏ V‚ÜíV‚ÜíP
                if "V‚ÜíV‚ÜíV" in pattern_str or pattern_str.count("V") >= 3:
                    pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.15
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] += 0.1  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                
                # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫: P‚ÜíP‚ÜíP –∏–ª–∏ P‚ÜíP‚ÜíV
                if "P‚ÜíP‚ÜíP" in pattern_str or (pattern_str.count("P") >= 3 and pay_ratio > 0.5):
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] += 0.2
                    pattern_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] += 0.15
                
                # –°–ª–æ–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π: V‚ÜíP‚ÜíV –∏–ª–∏ P‚ÜíV‚ÜíP
                if "V‚ÜíP‚ÜíV" in pattern_str or "P‚ÜíV‚ÜíP" in pattern_str:
                    pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.2
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] += 0.15  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                
                # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ—à–µ–Ω–∏–π: V‚ÜíP (–∫–æ—Ä–æ—Ç–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
                if len(pattern_str.split("‚Üí")) <= 3 and "V" in pattern_str and "P" in pattern_str:
                    pattern_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] += 0.15
                    pattern_scores["–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª"] += 0.1
            
            # 3. –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            unique_patterns = len(set(pattern_strings))
            if unique_patterns > 5:
                # –ú–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ = —Å–ª–æ–∂–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ = –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
                pattern_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] += 0.1
                pattern_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] += 0.1  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
        
        # –ë–∞–∑–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
        base_scores = {}
        
        # –ò–ø–æ—Ç–µ–∫–∞ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
        mortgage_score = 0.0
        
        # –°–∏–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∏–ø–æ—Ç–µ–∫–∏
        # 1. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: –∫—Ä—É–ø–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ + –∞–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        if high_value_customer > 0.4 and research_behavior > 0.5:
            mortgage_score += 0.35
        
        # 1.1. Retail –∑–∞–∫–∞–∑—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏/—Ä–µ–º–æ–Ω—Ç–∞ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        if num_retail_orders > 0 and check_category(top_category, CATEGORY_KEYWORDS["real_estate"][:4]):
            mortgage_score += 0.25
        
        # 2. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏/—Ä–µ–º–æ–Ω—Ç–∞ (—Å–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        real_estate_signal = 0.0
        if check_category(top_category, CATEGORY_KEYWORDS["real_estate"][:5]):
            real_estate_signal += 0.3
        
        if check_category(top_brand_category, CATEGORY_KEYWORDS["real_estate"]):
            real_estate_signal += 0.35
        
        real_estate_count = count_category_matches(brand_categories, CATEGORY_KEYWORDS["real_estate"][:3])
        if real_estate_count > 0:
            real_estate_signal += 0.2 * min(real_estate_count / 3.0, 1.0)
        
        mortgage_score += min(real_estate_signal, 0.4)  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–∫–ª–∞–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        
        # 3. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å + —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ = –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä—É–ø–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
        if engagement_duration > 0.5 and diversity_score > 0.4:
            mortgage_score += 0.25
        
        # 4. –ö—Ä—É–ø–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –∫—Ä—É–ø–Ω—ã–º –ø–æ–∫—É–ø–∫–∞–º
        if max_tx_normalized > 0.3:
            mortgage_score += 0.2 * max_tx_normalized
        
        # 5. –ú–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ä–∞–∑–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ = –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        if activity_intensity > 0.6 and diversity_score > 0.5:
            mortgage_score += 0.15
        
        # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ score
        def safe_score(base_value, min_value=0.05, multiplier=1.0):
            """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞—Å—á–µ—Ç score —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º."""
            return min(max(base_value * multiplier, 0), 1.0) if base_value > 0 else min_value
        
        base_scores["–°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞"] = safe_score(mortgage_score)

        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ª–∏–Ω–µ–π–∫–∞ –∏–ø–æ—Ç–µ—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–≥—Ä—É–ø–ø–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
        standard_mortgages = ["–ò–ø–æ—Ç–µ–∫–∞ ¬´–í—Ç–æ—Ä–∏—á–Ω–æ–µ –∂–∏–ª—å–µ¬ª", "–ò–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞¬ª"]
        for product in standard_mortgages:
            base_scores[product] = safe_score(mortgage_score)
        
        # –ì–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º—ã (–≥–µ–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ, –Ω–∏–∑–∫–∏–π –±–∞–∑–æ–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        geo_programs = ["–ì–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª", "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è –∏ –∞—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–ø–æ—Ç–µ–∫–∞"]
        for product in geo_programs:
            base_scores[product] = 0.05
        
        # –í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞
        military_mortgage_score = 0.05
        military_products = [
            "–°–µ–º–µ–π–Ω–∞—è –≤–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞", 
            "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞", 
            "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ ¬´–ù–æ–≤—ã–µ —Å—É–±—ä–µ–∫—Ç—ã¬ª",
            "–í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞ (–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)"
        ]
        for product in military_products:
            base_scores[product] = military_mortgage_score

        # –ó–∞–ª–æ–≥–æ–≤—ã–µ –∏ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        base_scores["–ö—Ä–µ–¥–∏—Ç –ø–æ–¥ –∑–∞–ª–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä—ã"] = safe_score(mortgage_score, multiplier=0.8)
        base_scores["–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏"] = safe_score(mortgage_score, multiplier=0.9)
        
        # –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
        card_score = 0.0
        
        # –°–∏–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã
        # 1. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω)
        if payment_frequency > 0.3 and 0.02 < avg_tx_normalized < 0.8:  # –°—Ä–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
            card_score += 0.4 * payment_frequency
        
        # 2. –ê–∫—Ç–∏–≤–Ω—ã–π —Å–ø–µ–Ω–¥–µ—Ä (–º–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π, —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
        if active_spender > 0.5:
            card_score += 0.35
        
        # 2.1. Retail –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É, –∑–∞–∫–∞–∑—ã) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        if num_add_to_cart > 0 or num_orders > 0:
            card_score += 0.2 * min((num_add_to_cart + num_orders) / 5.0, 1.0)
        
        # 3. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–µ–Ω–¥–æ–≤: —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è, —É—Å–ª—É–≥–∏, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        retail_signal = 0.0
        if check_category(top_brand_category, CATEGORY_KEYWORDS["retail"]):
            retail_signal += 0.3
        
        retail_count = count_category_matches(brand_categories, CATEGORY_KEYWORDS["retail"])
        if retail_count > 0:
            retail_signal += 0.2 * min(retail_count / 2.0, 1.0)
        
        card_score += min(retail_signal, 0.3)
        
        # 4. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
        if engagement_duration > 0.3 and payment_frequency > 0.25:
            card_score += 0.2
        
        # 5. –ë–∞–∑–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if num_payments > 0 or num_views > 0:
            card_score += 0.15
        
        base_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´100+¬ª"] = min(card_score, 1.0) if card_score > 0 else 0.15
        
        # –í–∫–ª–∞–¥ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π
        deposit_score = 0.0
        
        # –°–∏–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –≤–∫–ª–∞–¥–∞
        # 1. –ö—Ä—É–ø–Ω—ã–µ —Å—É–º–º—ã (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
        if max_tx_normalized > 0.5:  # –ë–æ–ª–µ–µ 100k
            deposit_score += 0.4 * max_tx_normalized
        
        # 2. –í—ã—Å–æ–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ + –º–Ω–æ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π = –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
        if avg_tx_normalized > 0.2 and payment_frequency > 0.4:
            deposit_score += 0.35
        
        # 3. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–µ–Ω–¥–æ–≤: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª—É–≥–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        finance_signal = 0.0
        if check_category(top_brand_category, CATEGORY_KEYWORDS["finance"]):
            finance_signal += 0.35
        
        finance_count = count_category_matches(brand_categories, CATEGORY_KEYWORDS["finance"])
        if finance_count > 0:
            finance_signal += 0.25 * min(finance_count / 2.0, 1.0)
        
        deposit_score += min(finance_signal, 0.35)
        
        # 4. –°—Ç–∞–±–∏–ª—å–Ω—ã–µ –∫—Ä—É–ø–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è)
        if avg_tx_normalized > 0.15 and payment_frequency > 0.3 and engagement_duration > 0.4:
            deposit_score += 0.2
        
        # 5. –í—ã—Å–æ–∫–∏–π –æ–±—â–∏–π –æ–±—ä–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        if high_value_customer > 0.6:
            deposit_score += 0.15
        
        base_scores["–í–∫–ª–∞–¥ ¬´–°–∏–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞¬ª"] = min(deposit_score, 1.0) if deposit_score > 0 else 0.1

        # –î—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥—ã - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–≥—Ä—É–ø–ø–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏)
        deposit_variants = [
            ("–í–∫–ª–∞–¥ ¬´–ú–æ–π –¥–æ—Ö–æ–¥¬ª", 1.0, 0.1),
            ("–í–∫–ª–∞–¥ ¬´–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥¬ª", 0.95, 0.09),
            ("–í–∫–ª–∞–¥ ¬´–ú–æ—è –∫–æ–ø–∏–ª–∫–∞¬ª", 0.9, 0.08),
            ("–í–∫–ª–∞–¥ ¬´–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª", 0.85, 0.08)
        ]
        for product, multiplier, min_val in deposit_variants:
            base_scores[product] = safe_score(deposit_score, min_value=min_val, multiplier=multiplier)

        # –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∫–ª–∞–¥—ã (–Ω–∏–∑–∫–∏–π –±–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä, –Ω—É–∂–Ω–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ ML)
        # –°—Ç–∞–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ (–ù–ü–§) - –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
        future_score = 0.05
        if engagement_duration > 0.6:
             future_score += 0.2
        base_scores["–í–∫–ª–∞–¥ ¬´–°—Ç–∞–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ¬ª"] = future_score

        # –î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π (–ú–µ—Ç–∞–ª–ª—ã) - –¥–ª—è —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö
        metal_score = 0.05
        if high_value_customer > 0.7:
             metal_score += 0.2
        base_scores["–í–∫–ª–∞–¥ ¬´–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π¬ª"] = metal_score

        # –í —é–∞–Ω—è—Ö - –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏–ª–∏ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        cny_score = 0.05
        if check_category(top_category, CATEGORY_KEYWORDS["travel"]):
             cny_score += 0.2
        if diversity_score > 0.7:
             cny_score += 0.15
        base_scores["–í–∫–ª–∞–¥ ¬´–í —é–∞–Ω—è—Ö¬ª"] = cny_score

        # –°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥
        base_scores["–í–∫–ª–∞–¥ ¬´–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥¬ª"] = 0.05
        
        # –ö—Ä–µ–¥–∏—Ç - —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
        loan_score = 0.0
        
        # –°–∏–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞
        # 1. –ê–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (–º–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ)
        if research_behavior > 0.6:
            loan_score += 0.4
        
        # 2. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å + —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ = –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        if engagement_duration > 0.4 and diversity_score > 0.5:
            loan_score += 0.35
        
        # 3. –°—Ä–µ–¥–Ω–∏–µ —Å—É–º–º—ã + –∞–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ = –∫—Ä–µ–¥–∏—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É
        if 0.1 < avg_tx_normalized < 0.5 and activity_intensity > 0.5:
            loan_score += 0.3
        
        # 4. –ú–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤ = —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã
        if diversity_score > 0.6:
            loan_score += 0.2
        
        # 5. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: —Ç–µ—Ö–Ω–∏–∫–∞, –∞–≤—Ç–æ, –∫—Ä—É–ø–Ω–∞—è –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        tech_keywords = CATEGORY_KEYWORDS["tech"] + ["–º–µ–±–µ–ª—å"]
        if check_category(top_category, tech_keywords):
            loan_score += 0.25
        
        # –î–æ–±–∞–≤–ª—è–µ–º boost –æ—Ç embedding diversity
        loan_score += embedding_loan_boost
        
        base_scores["–ö—Ä–µ–¥–∏—Ç –Ω–∞ –ª—é–±—ã–µ —Ü–µ–ª–∏"] = min(loan_score, 1.0) if loan_score > 0 else 0.08

        # –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
        refin_score = 0.0
        # –í–ê–ñ–ù–û: savings_score –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ–∑–∂–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        savings_estimate = payment_frequency * avg_tx_normalized
        if num_payments > 10 and savings_estimate < 0.3: # –ú–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π, –º–∞–ª–æ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π
             refin_score += 0.3
        if top_category and "bank" in str(top_category).lower(): # –ü–ª–∞—Ç–µ–∂–∏ –≤ –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏
             refin_score += 0.4
        base_scores["–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤"] = min(refin_score, 1.0) if refin_score > 0 else 0.05

        # –¢—É—Ä–±–æ–¥–µ–Ω—å–≥–∏ (—ç–∫—Å–ø—Ä–µ—Å—Å)
        turbo_score = 0.0
        if 0 < avg_tx_normalized < 0.15 and payment_frequency > 0.4: # –ß–∞—Å—Ç—ã–µ –º–µ–ª–∫–∏–µ —Ç—Ä–∞—Ç—ã
             turbo_score += 0.35
        base_scores["–≠–∫—Å–ø—Ä–µ—Å—Å-–∫—Ä–µ–¥–∏—Ç ¬´–¢—É—Ä–±–æ–¥–µ–Ω—å–≥–∏¬ª"] = min(turbo_score, 1.0) if turbo_score > 0 else 0.05

        # –ö—Ä–µ–¥–∏—Ç –û–ü–ö
        base_scores["–ö—Ä–µ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –û–ü–ö –∏ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏—Ö"] = 0.05
        
        # –î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ - –±–∞–∑–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞—Ç–Ω—É—é –ª–æ–≥–∏–∫—É: –µ—Å–ª–∏ –Ω–µ—Ç —Å–∏–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        debit_score = 0.3  # –ë–∞–∑–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö/–º–∞–ª–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if num_payments == 0 and num_views < 5:
            debit_score = 0.5  # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        elif num_payments > 0 and payment_frequency < 0.2:
            debit_score = 0.4  # –ú–∞–ª–æ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        elif active_spender < 0.3:
            debit_score = 0.35  # –ù–µ –æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø–µ–Ω–¥–µ—Ä
        
        base_scores["–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –∫—ç—à–±—ç–∫¬ª"] = debit_score
        
        # Premium Banking
        premium_score = 0.0
        if high_value_customer > 0.7:
            premium_score += 0.4
        if max_tx_normalized > 0.6:
            premium_score += 0.3
        if diversity_score > 0.6:
            premium_score += 0.2
        base_scores["–ü–∞–∫–µ—Ç ¬´Orange Premium Club¬ª"] = min(premium_score, 1.0) if premium_score > 0 else 0.0

        # Savings Account
        savings_score = 0.0
        if payment_frequency > 0.3 and avg_tx_normalized < 0.5:
             savings_score += 0.3
        if deposit_score > 0.4:
             savings_score += 0.3
        base_scores["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ê–∫—Ü–µ–Ω—Ç¬ª"] = min(savings_score, 1.0) if savings_score > 0 else 0.1

        # –î—Ä—É–≥–∏–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        # –ü—Ä–æ –∑–∞–ø–∞—Å - –¥–ª—è –Ω–æ–≤—ã—Ö –∏–ª–∏ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö
        pro_zapas_score = savings_score * 0.95
        if engagement_duration < 0.2: # –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
             pro_zapas_score += 0.2
        base_scores["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–ü—Ä–æ –∑–∞–ø–∞—Å¬ª"] = safe_score(pro_zapas_score, min_value=0.1)

        # –•—Ä–∞–Ω–∏—Ç–µ–ª—å - –¥–ª—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö
        base_scores["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç ¬´–•—Ä–∞–Ω–∏—Ç–µ–ª—å¬ª"] = safe_score(savings_score, min_value=0.09, multiplier=0.9)

        # CSKA Card - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        cska_score = 0.0
        if check_category(top_category, CATEGORY_KEYWORDS["sport"]):
            cska_score += 0.4
        if check_category(top_brand_category, CATEGORY_KEYWORDS["sport"]):
             cska_score += 0.3
        base_scores["–ö–ª—É–±–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–§–ö –¶–°–ö–ê"] = min(cska_score, 1.0) if cska_score > 0 else 0.0

        # SVOi Card
        # –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ML –∏–ª–∏ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
        base_scores["–ö–∞—Ä—Ç–∞ ¬´–°–í–û–∏¬ª"] = 0.05

        # Health Card "Tolko Vpered" - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        health_score = 0.0
        health_keywords = CATEGORY_KEYWORDS["health"]
        if check_category(top_category, health_keywords):
            health_score += 0.45
        if check_category(top_brand_category, health_keywords):
             health_score += 0.35
        base_scores["–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥¬ª"] = min(health_score, 1.0) if health_score > 0 else 0.0

        # Credit Card 180 days
        cc180_score = 0.0
        if max_tx_normalized > 0.4: # Big purchases
            cc180_score += 0.4
        if engagement_duration > 0.4: # Long term planning
             cc180_score += 0.2
        if card_score > 0.3: # If generic credit card is relevant
             cc180_score += 0.2
        base_scores["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´180 –¥–Ω–µ–π –±–µ–∑ %¬ª"] = min(cc180_score, 1.0) if cc180_score > 0 else 0.1

        # Pension Card
        pension_score = 0.05
        # Heuristic: small avg tx, pharmacy/grocery spending, but harder to distinguish from students without age.
        # We give it low score to be picked up if patterns match via ML or specific rules.
        if 0 < avg_tx_normalized < 0.2 and payment_frequency > 0.3:
             pension_score += 0.2
        base_scores["–î–µ–±–µ—Ç–æ–≤–∞—è –ø–µ–Ω—Å–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –ü–°–ë"] = pension_score
        
        # Salary Cards (Tvoy Plus, Zarkplata PRO) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        salary_score = 0.0
        if num_payments > 5 and active_spender > 0.4:
             salary_score += 0.3
        for product in ["–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–¢–≤–æ–π –ü–ª—é—Å¬ª", "–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–ó–∞—Ä–ø–ª–∞—Ç–∞ PRO¬ª"]:
            base_scores[product] = salary_score

        # Military Salary (Silnye Lyudi)
        base_scores["–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ¬´–°–∏–ª—å–Ω—ã–µ –ª—é–¥–∏¬ª"] = 0.05

        # City Card
        base_scores["–ö–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è"] = 0.1
        
        # Insurance and Ecosystem Products - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        # Auto
        auto_score = 0.0
        if check_category(top_category, CATEGORY_KEYWORDS["auto"]):
             auto_score += 0.4
        base_scores["–û–°–ê–ì–û"] = min(auto_score, 1.0) if auto_score > 0 else 0.05
        base_scores["–ê–≤—Ç–æ–ø–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö"] = min(auto_score, 1.0) if auto_score > 0 else 0.05
        
        # Health
        health_ins_score = 0.0
        health_keywords_short = CATEGORY_KEYWORDS["health"][:4]  # ["health", "medical", "pharmacy", "doctor"]
        if check_category(top_category, health_keywords_short):
             health_ins_score += 0.4
        base_scores["–ë—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã"] = min(health_ins_score, 1.0) if health_ins_score > 0 else 0.05
        base_scores["–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π"] = min(health_ins_score * 0.8, 1.0) if health_ins_score > 0 else 0.05
        
        # Property & Housing
        prop_score = 0.0
        if mortgage_score > 0.3 or check_category(top_category, CATEGORY_KEYWORDS["property"]):
             prop_score += 0.35
        base_scores["–ú–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è"] = min(prop_score, 1.0) if prop_score > 0 else 0.05
        base_scores["–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏"] = min(prop_score * 0.9, 1.0) if prop_score > 0 else 0.05
        base_scores["–ü—Ä–∏–µ–º–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∂–∏–ª—å—è"] = min(prop_score * 0.8, 1.0) if prop_score > 0 else 0.05
        
        # Travel
        travel_score = 0.0
        if check_category(top_category, CATEGORY_KEYWORDS["travel"]):
             travel_score += 0.4
        base_scores["–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤"] = min(travel_score, 1.0) if travel_score > 0 else 0.05
        
        # Financial Protection
        prot_score = 0.1
        if active_spender > 0.5:
             prot_score += 0.2
        base_scores["–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞"] = prot_score
        base_scores["–ó–∞—â–∏—Ç–∞ –≤–∫–ª–∞–¥–∞"] = 0.2 if deposit_score > 0.3 else 0.05
        base_scores["–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Ä–∞–±–æ—Ç—ã"] = 0.2 if loan_score > 0.3 else 0.05
        base_scores["–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∑–∞–µ–º—â–∏–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–æ–≤"] = 0.3 if loan_score > 0.4 else 0.05
        base_scores["–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ—á–Ω—ã—Ö –∑–∞–µ–º—â–∏–∫–æ–≤"] = 0.3 if mortgage_score > 0.4 else 0.05
        
        # Legal & Life
        base_scores["–ú—É–ª—å—Ç–∏–Æ—Ä–∏—Å—Ç"] = 0.1
        base_scores["–î–æ–º–∞—à–Ω–∏–π –∫—ç—à–±—ç–∫"] = 0.05
        base_scores["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∂–∏–∑–Ω–∏"] = 0.2 if high_value_customer > 0.5 else 0.05
        
        # Investments (PSB Invest)
        invest_score = 0.0
        # 1. High savings/value
        if deposit_score > 0.5 or high_value_customer > 0.6:
             invest_score += 0.35
        # 2. Interest in finance
        if finance_signal > 0.3:
             invest_score += 0.3
        # 3. Diversity (looking for options)
        if diversity_score > 0.6:
             invest_score += 0.2
        base_scores["–ü–°–ë –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"] = min(invest_score, 1.0) if invest_score > 0 else 0.05
        
        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏
        final_scores = {}
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã
        has_graph = graph is not None and graph.number_of_nodes() > 0
        has_patterns = patterns and len(patterns) > 0
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–µ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
        if has_graph and has_patterns:
            # –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã - —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Å–∞
            base_weight, graph_weight, pattern_weight = 0.4, 0.35, 0.25
        elif has_graph:
            # –¢–æ–ª—å–∫–æ –≥—Ä–∞—Ñ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ–≥–æ –≤–µ—Å
            base_weight, graph_weight, pattern_weight = 0.5, 0.5, 0.0
        elif has_patterns:
            # –¢–æ–ª—å–∫–æ –ø–∞—Ç—Ç–µ—Ä–Ω—ã - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏—Ö –≤–µ—Å
            base_weight, graph_weight, pattern_weight = 0.6, 0.0, 0.4
        else:
            # –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            base_weight, graph_weight, pattern_weight = 1.0, 0.0, 0.0
        
        for product in self.products:
            final_scores[product] = (
                base_scores.get(product, 0) * base_weight +
                graph_scores.get(product, 0) * graph_weight +
                pattern_scores.get(product, 0) * pattern_weight
            )
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º, —á—Ç–æ–±—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –±—ã–ª–∞ 1.0
            if final_scores[product] > 1.0:
                final_scores[product] = 1.0
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±—ã–ª–∞ 1.0
        max_score = max(final_scores.values()) if final_scores else 1.0
        if max_score > 0:
            for product in final_scores:
                final_scores[product] = final_scores[product] / max_score
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∫–µ
        sorted_products = sorted(final_scores.items(), key=lambda x: x[1], reverse=True)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –ü–°–ë)
        generic_products = ["–ö—Ä–µ–¥–∏—Ç", "–ò–ø–æ—Ç–µ–∫–∞", "–ö—Ä–µ–¥–∏—Ç–∫–∞", "–í–∫–ª–∞–¥", "–î–µ–±–µ—Ç", "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞", "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞"]
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ —Ç–∏–ø–∞–º
        def get_product_type(product_name: str) -> str:
            """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏."""
            product_lower = product_name.lower()
            if "–∏–ø–æ—Ç–µ–∫" in product_lower:
                return "mortgage"
            elif "–∫—Ä–µ–¥–∏—Ç–Ω" in product_lower and "–∫–∞—Ä—Ç" in product_lower:
                return "credit_card"
            elif "–¥–µ–±–µ—Ç–æ–≤" in product_lower or "–∑–∞—Ä–ø–ª–∞—Ç–Ω" in product_lower or "–ø–µ–Ω—Å–∏–æ–Ω–Ω" in product_lower or "–∫–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è" in product_lower or "—Ü—Å–∫–∞" in product_lower or "—Å–≤–æ–∏" in product_lower:
                return "debit_card"
            elif "–∫—Ä–µ–¥–∏—Ç" in product_lower and "–∫–∞—Ä—Ç" not in product_lower:
                return "loan"
            elif "–≤–∫–ª–∞–¥" in product_lower:
                return "deposit"
            elif "–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç" in product_lower:
                return "savings"
            elif "–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏" in product_lower:
                return "investment"
            elif "—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω" in product_lower or "–º—É–ª—å—Ç–∏—é—Ä–∏—Å—Ç" in product_lower or "–∑–∞—â–∏—Ç–∞" in product_lower or "–∫—ç—à–±—ç–∫" in product_lower or "–æ—Å–∞–≥–æ" in product_lower or "–ø–æ–º–æ—â—å" in product_lower or "–∑–¥–æ—Ä–æ–≤—ã" in product_lower:
                return "insurance_service"
            elif "–ø–∞–∫–µ—Ç" in product_lower or "orange" in product_lower or "premium" in product_lower:
                return "package"
            else:
                return "other"
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
        selected_products = []
        used_types = set()
        max_per_type = 1  # –ú–∞–∫—Å–∏–º—É–º 1 –ø—Ä–æ–¥—É–∫—Ç –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
        
        for product, score in sorted_products:
            # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–¥—É–∫—Ç –≤ —Å–ø–∏—Å–∫–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ü–°–ë
            if product in generic_products or product not in self.products:
                continue
            
            product_type = get_product_type(product)
            
            # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: –Ω–µ –±–æ–ª–µ–µ max_per_type –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
            type_count = sum(1 for p in selected_products if get_product_type(p["product"]) == product_type)
            if type_count < max_per_type:
                selected_products.append({
                    "product": product,
                    "score": float(score)
                })
                used_types.add(product_type)
                
                if len(selected_products) >= top_k:
                    break
        
        # –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ score
        if len(selected_products) < top_k:
            for product, score in sorted_products:
                if len(selected_products) >= top_k:
                    break
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏ –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if product in generic_products or product not in self.products:
                    continue
                
                if not any(p["product"] == product for p in selected_products):
                    selected_products.append({
                        "product": product,
                        "score": float(score)
                    })
        
        return selected_products[:top_k]


def recommend(
    user_profile: Dict,
    model_path: Optional[str] = None,
    top_k: int = 3,
    graph: Optional[any] = None,
    patterns: Optional[List] = None
) -> List[Dict[str, any]]:
    """
    –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    :param user_profile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    :param model_path: –ü—É—Ç—å –∫ –º–æ–¥–µ–ª–∏
    :param top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    :param graph: –ì—Ä–∞—Ñ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ fallback)
    :param patterns: –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ fallback)
    :return: –°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    """
    model = NBOModel(model_path=model_path)
    return model.predict(user_profile, top_k=top_k, graph=graph, patterns=patterns)

